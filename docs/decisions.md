# tmuxui 意思決定ログ

**バージョン**: 1.1
**最終更新**: 2026年2月21日（D6-D11更新）

---

## 概要

プロジェクト全体を通じた技術選定、アーキテクチャ設計、機能判断の記録。

---

## 決定済み事項

### D1: 一体型構成（フロント + バック 1プロセス）

**決定日**: 2026年2月21日
**決定者**: チームリード
**ステータス**: 確定

#### 決定内容

フロントエンド（HTML/CSS/JS）とバックエンド（サーバー）を単一バイナリに統合。

#### 理由

✅ デプロイが簡単（`./tmuxui` のみ）
✅ 依存関係の最小化（パッケージマネージャ不要）
✅ ポートフォワード環境での動作を確保
✅ セットアップコストの削減

#### 実装方式

- バックエンド: Go または Rust
- フロントエンド資源: バイナリに埋め込み（go:embed / include_str! など）
- 起動時: localhost:任意ポート で Web サーバー起動

#### 関連ドキュメント

- requirements.md: U5, U6

---

### D2: 軽量・依存関係最小化

**決定日**: 2026年2月21日
**決定者**: チームリード
**ステータス**: 確定

#### 決定内容

外部ライブラリを極力排除し、標準ライブラリと最小限の信頼できるパッケージのみ利用。

#### 理由

✅ 起動速度・メモリ効率を優先
✅ セキュリティリスク低減（依存パッケージのバグ/脆弱性減少）
✅ パッケージ管理の負担削減
✅ エアギャップ環境での稼働対応

#### 採用基準

| 項目 | 基準 |
|------|------|
| フレームワーク | 標準ライブラリ + WebSocket ライブラリ程度に留める |
| フロント UI | シンプル HTML/CSS（フレームワーク不要） |
| ターミナル表示 | 既存ライブラリ活用か、軽量実装 |

#### 検討対象外

❌ React/Vue などのフロントエンドフレームワーク
❌ ORM/DB ライブラリ
❌ CDN 外部依存

---

### D3: ダークモードのみ対応

**決定日**: 2026年2月21日
**決定者**: デザイナー/チームリード
**ステータス**: 確定

#### 決定内容

ライトモード を実装しない。ダークモード のみ提供。

#### 理由

✅ スマートフォンのバッテリー節約（OLED 画面対応）
✅ CLI・ターミナル環境との視覚的統一
✅ 実装・テスト負荷の削減
✅ 夜間の使用シーンに最適

#### 色設定

| 要素 | 色コード |
|------|---------|
| 背景 | #1a1a1a |
| テキスト（標準） | #e0e0e0 |
| 成功 | #51cf66 |
| エラー | #ff6b6b |
| 警告 | #ffa94d |
| 情報 | #4dabf7 |

参考: ux-design.md 第7章

---

### D4: 手動更新（自動更新なし）

**決定日**: 2026年2月21日
**決定者**: PM/チームリード
**ステータス**: 確定

#### 決定内容

ペイン内容の更新は手動更新（🔄ボタン）。自動ポーリング不可。

#### 理由

✅ モバイルネットワーク消費量を最小化
✅ スマートフォンバッテリー消費削減
✅ サーバー負荷軽減
✅ ユーザーが必要な時点でのみ更新

#### UI 表現

- 更新ボタン: 回転アニメーション付き 🔄
- タイムスタンプ: "最終更新: HH:MM" を表示
- 更新完了: ボタンアニメーション終了で通知

---

### D5: セキュリティ最優先（確認ダイアログ必須）

**決定日**: 2026年2月21日
**決定者**: セキュリティ担当/チームリード
**ステータス**: 確定

#### 決定内容

すべての重要操作（権限許可、コマンド送信）に確認ダイアログを必須化。

#### 理由

✅ 誤操作防止（タッチ操作の誤タップ対策）
✅ 権限許可の意図的操作を保証
✅ スマートフォン盗難時の被害最小化

#### 実装基準

| 操作 | 確認 | 条件 |
|------|------|------|
| 権限許可 | 必須 | すべての許可/拒否 |
| コマンド送信（カスタム） | 必須 | テキスト入力時 |
| コマンド送信（プリセット） | 推奨 | ユーザー設定で変更可能 |
| ペイン表示 | 不要 | - |

#### タップターゲット

- 最小サイズ: 48px × 48px（Apple HIG 準拠）
- ボタン間距離: 最小 8px
- デフォルトフォーカス: 否定側（「いいえ」）

参考: ux-design.md 第6章

---

## 検討中・今後の意思決定

### D6: バックエンド言語選定 → Go 確定

**決定日**: 2026年2月21日
**決定者**: architect
**ステータス**: ✅ 確定

#### 決定内容

バックエンド言語に **Go** を採用。

#### 選択肢と比較

| 項目 | **Go** | **Bun** | **Bun + Hono** | **Rust** |
|------|:---:|:---:|:---:|:---:|
| 起動 | `./tmuxui` | `bun run` | 同左 | `./tmuxui` |
| バイナリサイズ | **~10-15MB** | ~57MB | ~57MB | ~15-20MB |
| 外部依存 | **1個** | 0個 | 1個 | 20個以上 |
| 静的ファイル埋込 | `//go:embed web/*`（ディレクトリ丸ごと） | ファイル個別import | 同左 | include_str! |
| コンパイル速度 | **~2秒** | ~0.2秒 | 同左 | 数分 |
| 言語統一 | Go + JS | TS一本 | TS一本 | Rust + JS |
| 開発時リロード | 再ビルド | ホットリロード | 同左 | 再ビルド |
| ランタイム成熟度 | **非常に高い** | v1.3（発展途上） | 同左 | 非常に高い |

#### 選定理由

1. **静的ファイル埋め込みの信頼性** ⭐
   - Go の `//go:embed web/*` でディレクトリを**一行で埋め込み**
   - Bun は `import with { type: "file" }` でファイル個別指定が必須
   - ファイル追加のたびに import 文を追加する手間（Go は不要）

2. **真の自己完結バイナリ**
   - Go バイナリ（10-15MB）は OS 標準ライブラリ以外に依存なし
   - Bun compile（57MB）は Bun ランタイムをバンドルするため、サイズが 4 倍以上

3. **安定性 / 保守コスト**
   - `net/http` は 15 年以上の実績。枯れた技術
   - Bun は v1.3（急速に成熟中だが、個人ツール用途には枯れた技術が有利）
   - 「一度作って長く使う」用途に適合

4. **開発時リロード問題は devmode フラグで解決** ✅
   - `--dev` フラグでファイルシステムから直接読み込み（後述）
   - HTML/JS 変更時のブラウザリロードで即反映（再ビルド不要）

#### Bun が上回る点（トレードオフの認識）

- 外部依存ゼロ（Go: 1個）
- TypeScript 一本の言語統一
- ホットリロードの開発体験

ただし、**フロント 3 ファイル・API エンドポイント 4 個のこの規模では、これらのメリット差は実効的に小さい**。

#### 技術スタック

```
HTTPサーバー: net/http（標準ライブラリ）
WebSocket: gorilla/websocket（外部依存1個のみ）
静的ファイル埋込: //go:embed web/* (標準ライブラリ)
バイナリサイズ: ~10-15MB
```

参考: architecture.md 第 1 章、第 9 章

---

### D7: フロントエンド構築方法 → Vanilla JS 確定

**決定日**: 2026年2月21日
**決定者**: architect
**ステータス**: ✅ 確定

#### 決定内容

フロントエンドは **素の HTML/CSS/JavaScript**（フレームワークなし、ビルドステップなし）で実装。

#### 構成

```
web/
├── index.html       # メインHTML（SPA）
├── app.js           # フロントエンドロジック（vanilla JS）
└── style.css        # スタイル（ダークモード）
```

#### 選択肢と比較

| 方式 | 画面数 | API数 | 判定 |
|------|:---:|:---:|:---:|
| **Vanilla JS** | 3つ | 4個 | **採用** ✅ |
| htmx + Alpine | 3つ | 4個 | 軽量だが依存あり |
| Vue 3 | 3つ | 4個 | ビルドツール必要（過剰） |
| Hono JSX (SSR) | - | - | Go採用のため対象外 |
| 単一HTMLファイル | 3つ | 4個 | 開発時の編集性が悪い |

#### 選定理由

**規模がフレームワーク不要レベル**

- **ページ数**: 3 画面（ペイン一覧、ペイン詳細、権限許可ダイアログ）
- **コンポーネント数**: 5 個程度
- **API エンドポイント**: 4 個
- **状態管理**: WebSocket + DOM の単純な連携

この規模に React/Vue/Preact は **過剰設計**。

#### 実装方針

- **フレームワークなし**: Vanilla JavaScript で十分
- **ビルドステップなし**: TypeScript・バンドラ不要
- **CDN依存なし**: 全アセット（HTML/CSS/JS）を embed でバイナリに埋め込み
- **SPA構成**: index.html に JS で画面遷移を実装
  - History API は不使用（hash routing で十分）
  - 画面切り替えはDOM要素のshow/hideで実装
- **WebSocket接続**: app.js でペイン更新・権限許可ダイアログ管理

#### トレードオフの認識

- 複雑な状態管理が必要になった場合は、後々 Vue など導入可能
- 現時点では利益が明確でないため、最小構成を採用

参考: architecture.md 第 2 章、第 9 章

---

### D11: 開発モード（--dev フラグ）

**決定日**: 2026年2月21日
**決定者**: architect
**ステータス**: ✅ 確定

#### 決定内容

開発時のUI/CSS変更反映を高速化するため、**`--dev` フラグで embed.FS を使わずにファイルシステムから直接読み込むモード**を実装。

#### 動作仕様

**本番モード（デフォルト）:**
```go
//go:embed web/*
var webFS embed.FS

mux.Handle("/", http.FileServer(http.FS(webFS)))
```

- 起動時に web/ 配下全ファイルがバイナリに埋め込まれる
- 起動後のファイル変更は反映されない
- `go build` で再ビルド必須

**開発モード（--dev フラグ）:**
```go
if devMode {
    mux.Handle("/", http.FileServer(http.Dir("web/")))
} else {
    mux.Handle("/", http.FileServer(http.FS(webFS)))
}
```

- ファイルシステムから直接読み込み
- HTML/CSS/JS 変更後、ブラウザリロードで即座に反映
- Go 再ビルド不要

#### 使用例

```bash
# 開発時: devモードで起動（リロード対応）
./tmuxui --dev

# ブラウザで http://localhost:8080?token=xxx にアクセス
# web/app.js や style.css を編集 → ブラウザリロード → 変更反映

# 本番ビルド: dev フラグなしで起動
go build -o tmuxui .
./tmuxui
```

#### メリット

✅ フロントエンド開発時の変更反映が高速（再ビルド不要）
✅ ブラウザリロードだけで CSS/JS の変更を確認可能
✅ D6（Go選定）による「再ビルド必須」問題を解消

#### D6 との関連性

D6 で Go を選定した際の課題「フロント変更で毎回 Go 再ビルドが必要」を、この devmode フラグで解消。Go の embed 埋め込みの利点を保ちつつ、開発効率も両立。

参考: architecture.md 第 2 章 devモード、第 10 章 CLIオプション

---

### D8: Claude Code hooks 統合方式

**状態**: 🔄 検討中

#### 課題

- リード側の permission request を スマートフォン UI で受け取る仕組み
- スマートフォン側の承認結果を Claude Code へ返送する仕組み

#### アプローチ案

1. **WebSocket + Hook イベント**: リード側から permission request を WebSocket で配信
2. **ポーリング**: スマートフォン側が定期的にリード側の状態をポーリング
3. **外部キューサービス**: Redis/SQS などを介した非同期通信

#### 推奨度

**暫定: Option 1（WebSocket 直接統合）**

#### 決定予定

claude-code-hooks-multi-agent-observability の実装を参考に確定。

---

### D9: プッシュ通知対応（将来対応）

**状態**: ❌ 将来検討

#### 概要

権限許可リクエスト時にモバイル OS のプッシュ通知を送信。

#### 実装予定

Phase 3（拡張フェーズ）以降。ユーザー設定で無効化可能に。

#### 参考

ux-design.md 第8章 通知セクション

---

### D10: セッションロック機能（将来対応）

**状態**: ❌ 将来検討

#### 概要

5分無操作で画面ロック → パスコード/生体認証で再度アクセス。

#### 実装予定

Phase 3（拡張フェーズ）以降。セキュリティ強化目的。

---

## 決定プロセステンプレート

新たな意思決定が必要な場合、以下のテンプレートを使用してください：

```markdown
### D[番号]: [決定タイトル]

**決定日**: YYYY年M月DD日
**決定者**: [名前]
**ステータス**: 確定 / 🔄 検討中 / ❌ 将来検討

#### 決定内容

[決定内容を明確に記述]

#### 理由

[実装/非実装の理由を列挙]

#### 選択肢の比較

| 項目 | 選択肢A | 選択肢B |
|------|---------|---------|
| ... | ... | ... |

#### 影響範囲

- 要件: [requirements.md の該当セクション]
- アーキテクチャ: [実装への影響]
- スケジュール: [実装期間への影響]

#### 参考資料

[関連ドキュメント、外部リンク等]
```

---

## 関連ドキュメント

- **requirements.md**: 要件定義書（決定事項の背景）
- **ux-design.md**: UI/UX 詳細設計（D3, D4, D5 に関連）
- **research.md**: 既存ソリューション調査（D6, D8 に関連）
